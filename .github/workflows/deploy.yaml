# =============================================================================
# Pipeline de despliegue automÃ¡tico con GitHub Actions
# =============================================================================
# Esta pipeline se ejecuta en el mismo host donde se despliega la aplicaciÃ³n,
# por lo que puede ejecutar directamente el script de deploy sin necesidad de SSH.
#
# ConfiguraciÃ³n:
# - Runner: self-hosted (ejecutÃ¡ndose en el servidor de producciÃ³n)
# - Trigger: Manual (workflow_dispatch) o automÃ¡tico en push a main
# =============================================================================

name: ðŸš€ Deploy to Production Server

on:
  # Descomenta para despliegue automÃ¡tico en push a main
  # push:
  #   branches: [ "main" ]
  # Despliegue manual desde la interfaz de GitHub
  workflow_dispatch:

# ConfiguraciÃ³n de concurrencia para evitar despliegues simultÃ¡neos
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: ðŸ—ï¸ Deploy Application
    runs-on: self-hosted
    environment: prd  # Usa el environment 'prd' para protecciÃ³n adicional
    
    steps:
      - name: ðŸ”§ Configurar SSH
        run: |
          echo "Configurando conexiÃ³n SSH..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # AÃ±adir el host a known_hosts para evitar prompts interactivos
          ssh-keyscan -t rsa,ed25519 "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts
          
          echo "âœ… ConfiguraciÃ³n SSH completada"

      - name: ðŸš€ Ejecutar despliegue remoto
        run: |
          echo "Iniciando despliegue en el servidor remoto..."
          echo "Servidor: ${{ secrets.DEPLOY_HOST }}"
          echo "Usuario: ${{ secrets.DEPLOY_USER }}"
          echo "PROJECT_DIR: ${{ env.PROJECT_DIR }}"
          
          # Ejecutar actualizaciÃ³n del cÃ³digo y despliegue en el servidor remoto
          ssh -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
              "cd ${{ env.PROJECT_DIR }} && \
               echo '[DEPLOY] Actualizando cÃ³digo desde el repositorio...' && \
               echo '[DEPLOY] Obteniendo todos los cambios remotos...' && \
               git fetch --all && \
               echo '[DEPLOY] Reseteando a la rama main (descartando cambios locales)...' && \
               git reset --hard origin/main && \
               echo '[DEPLOY] CÃ³digo actualizado correctamente' && \
               chmod +x cicd/deploy.sh && \
               bash cicd/deploy.sh"
          
          echo "âœ… Despliegue completado exitosamente"

      - name: ðŸ“Š Verificar estado del despliegue
        run: |
          echo "Verificando estado de los contenedores..."
          ssh -o StrictHostKeyChecking=yes \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
              "cd ${{ env.PROJECT_DIR }} && docker compose ps"
          
          echo "âœ… VerificaciÃ³n completada"      