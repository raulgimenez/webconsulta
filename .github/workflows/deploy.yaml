# =============================================================================
# Pipeline de despliegue autom√°tico con GitHub Actions
# =============================================================================
# Esta pipeline se ejecuta en el mismo host donde se despliega la aplicaci√≥n,
# por lo que puede ejecutar directamente el script de deploy sin necesidad de SSH.
#
# Configuraci√≥n:
# - Runner: self-hosted (ejecut√°ndose en el servidor de producci√≥n)
# - Trigger: Manual (workflow_dispatch) o autom√°tico en push a main
# =============================================================================

name: üöÄ Deploy to Production Server

on:
  # Descomenta para despliegue autom√°tico en push a main
  # push:
  #   branches: [ "main" ]
  # Despliegue manual desde la interfaz de GitHub
  workflow_dispatch:

# Configuraci√≥n de concurrencia para evitar despliegues simult√°neos
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: üèóÔ∏è Deploy Application
    runs-on: self-hosted
    environment: prd  # Usa el environment 'prd' para protecci√≥n adicional
    
    steps:
      - name: üöÄ Despliegue local
        run: |
          export PROJECT_DIR={{vars.PROJECT_DIR}}
          git config --global --add safe.directory "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          export GIT_SSH_COMMAND='ssh -i /home/deploy/.ssh/id_ed25519 -o StrictHostKeyChecking=yes -o UserKnownHostsFile=/home/deploy/.ssh/known_hosts'
          git fetch --all && git reset --hard origin/main
          chmod +x cicd/deploy.sh
          bash cicd/deploy.sh