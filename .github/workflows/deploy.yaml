# =============================================================================
# Pipeline de despliegue autom√°tico con GitHub Actions
# =============================================================================
# Esta pipeline se ejecuta en el mismo host donde se despliega la aplicaci√≥n,
# por lo que puede ejecutar directamente el script de deploy sin necesidad de SSH.
#
# Configuraci√≥n:
# - Runner: self-hosted (ejecut√°ndose en el servidor de producci√≥n)
# - Trigger: Manual (workflow_dispatch) o autom√°tico en push a main
# =============================================================================

name: üöÄ Deploy to Production Server

on:
  # Descomenta para despliegue autom√°tico en push a main
  push:
    branches: [ "main" ]
  # Despliegue manual desde la interfaz de GitHub
  workflow_dispatch:

# Configuraci√≥n de concurrencia para evitar despliegues simult√°neos
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: üèóÔ∏è Deploy Application
    runs-on: self-hosted
    environment: prd  # Usa el environment 'prd' para protecci√≥n adicional
    
    steps:
      - name: üë§ Comprobar usuario efectivo
        run: |
          whoami
          id
          sudo -u deploy -H bash -lc 'echo "Dentro de sudo -> $(whoami)"; id'

      - name: üöÄ Despliegue local
        run: |
          sudo -u deploy -H bash -lc '
            set -euo pipefail

            export HOME=/home/deploy
            PROJECT_DIR="${{ vars.PROJECT_DIR }}"

            if [ -z "$PROJECT_DIR" ]; then
              echo "[DEPLOY] ERROR: PROJECT_DIR vac√≠o"
              exit 1
            fi

            # Forzar GitHub SSH por 443 (independiente de ~/.ssh/config)
            KEY="/home/deploy/.ssh/id_ed25519"
            KNOWN="/home/deploy/.ssh/known_hosts"
            export GIT_SSH_COMMAND="ssh -i $KEY -o IdentitiesOnly=yes -o BatchMode=yes -o StrictHostKeyChecking=yes -o UserKnownHostsFile=$KNOWN -o ConnectTimeout=8 -p 443 -o HostName=ssh.github.com"

            # Por si Git se queja de ownership ‚Äúdubious‚Äù
            git config --global --add safe.directory "$PROJECT_DIR" || true

            cd "$PROJECT_DIR"

            echo "[DEPLOY] git fetch/reset..."
            git fetch --all --prune
            git reset --hard origin/main

            echo "[DEPLOY] ejecutar script"
            chmod +x cicd/deploy.sh
            bash cicd/deploy.sh
          '