# =============================================================================
# Pipeline de despliegue autom√°tico con GitHub Actions
# =============================================================================
# Esta pipeline se ejecuta en el mismo host donde se despliega la aplicaci√≥n,
# por lo que puede ejecutar directamente el script de deploy sin necesidad de SSH.
#
# Configuraci√≥n:
# - Runner: self-hosted (ejecut√°ndose en el servidor de producci√≥n)
# - Trigger: Manual (workflow_dispatch) o autom√°tico en push a main
# =============================================================================

name: üöÄ Deploy to Production Server

on:
  # Descomenta para despliegue autom√°tico en push a main
  # push:
  #   branches: [ "main" ]
  # Despliegue manual desde la interfaz de GitHub
  workflow_dispatch:

# Configuraci√≥n de concurrencia para evitar despliegues simult√°neos
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: üèóÔ∏è Deploy Application
    runs-on: self-hosted
    environment: prd  # Usa el environment 'prd' para protecci√≥n adicional
    
    steps:
      - name: üì• Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Obtener todo el historial para git fetch --all

      - name: üöÄ Ejecutar despliegue
        // directorio de trabajo deonde hemoss hecho el checkout en el paso eanterior
        working-directory: ${{ github.workspace }}
        run: |
          echo "Iniciando despliegue en el servidor local..."
          echo "Directorio de trabajo: $(pwd)"
          echo "PROJECT_DIR: ${{ vars.PROJECT_DIR }}"
          
          # Validar que el directorio existe
          if [ ! -d "${{ vars.PROJECT_DIR }}" ]; then
            echo "‚ùå Error: El directorio ${{ vars.PROJECT_DIR }} no existe"
            exit 1
          fi
          
          # Hacer el script ejecutable si no lo es
          chmod +x cicd/deploy.sh
          
          # Ejecutar el script de despliegue directamente
          # El script ya maneja la actualizaci√≥n del c√≥digo con git fetch/reset
          bash cicd/deploy.sh
          
          echo "‚úÖ Despliegue completado exitosamente"

      - name: üìä Verificar estado del despliegue
        working-directory: ${{ vars.PROJECT_DIR }}
        run: |
          echo "Verificando estado de los contenedores..."
          echo "Directorio de trabajo: $(pwd)"
          docker compose ps
          
          echo "‚úÖ Verificaci√≥n completada"